from faker import Faker

from ralgo.ralgo import Ralgo
from ralgo.exceptions import DecodeError, CharsError

fake = Faker()


def test_decode_basic():
    message = ".....,,,,,,,...............,.......,......,,.......,.......,,.,............,.,,....,......,.......,,.......,,.....,..,.,..,,.......,......,,.......,...,,,.,,.....,........,.......,......,,....,,.,......,.,..............,.......,......,.......,,......,.,.....,.,......,"
    decoded = Ralgo(message).decode()

    assert str(decoded) == "Salut"

    # =======================

    message = ".,,,,,,,.........,.,..,,,.......,......,"
    decoded = Ralgo(message).decode()

    assert str(decoded) == "S"

    # =======================

    message = fake.text()

    encoded = Ralgo(message).encode()
    decoded = encoded.decode()

    assert str(decoded) == message


def test_decode_chars():
    message = "*****-------***************-*******-******--*******-*******--*-************-*--****-******-*******--*******--*****-**-*-**--*******-******--*******-***---*--*****-********-*******-******--****--*-******-*-**************-*******-******-*******--******-*-*****-*-******-"
    chars = ("*", "-")
    decoded = Ralgo(message).decode(chars=chars)

    assert str(decoded) == "Salut"

    # =======================

    message = "0111111100000000010100111000000010000001"
    chars = ("0", "1")
    decoded = Ralgo(message).decode(chars=chars)

    assert str(decoded) == "S"

    # =======================

    message = fake.text()
    chars = ("-", "â€”")

    encoded = Ralgo(message).encode(chars=chars)
    decoded = encoded.decode(chars=chars)

    assert str(decoded) == message

    # =======================

    message = "1" * 42
    chars = ("1", "1")

    try:
        _ = Ralgo(message).encode(chars=chars)
        assert False
    except CharsError as e:
        assert "Given chars must not be the same" == e.message


def test_decode_depth():
    message = ".........,,,,,,,...............,.......,......,,.......,......,.,....,.........,.,,....,......,,.......,.......,,....,.........,.......,.......,.......,.......,,,.,..,........,.......,......,.......,,.......,,,.............,.......,.......,....,,.,...,,,.,,..............,.......,......,.......,,.......,,....,.........,.......,.......,.......,.......,,,.,.....,.,..,,.......,.......,.......,......,.,.....,........,.......,......,,.......,.......,,.......,......,"

    decoded = Ralgo(message).decode(depth=9)

    assert str(decoded) == "Salut"

    # =======================

    message = ".,,,,,,,...............,.......,......,,.......,......,.,....,.........,.,,....,......,,.......,.......,,....,.........,.......,.......,.......,.......,,,.,..,........,.......,......,.......,,.......,,,.............,.......,.......,....,,.,...,,,.,,..............,.......,......,.......,,.......,,....,.........,.......,.......,.......,.......,,,.,.....,.,..,,.......,.......,.......,......,.,.....,........,.......,......,,.......,.......,,.......,......,"

    try:
        _ = Ralgo(message).decode()
        assert False
    except DecodeError as e:
        assert "Failed to decode one layer" == e.message

    # =======================

    message = fake.text()
    depth = 12

    encoded = Ralgo(message).encode(depth=depth)
    decoded = encoded.decode(depth=depth)

    assert str(decoded) == message


def test_decode_bits():
    message = ".......,,,,,,,,,...................,.........,.........,........,,........,.,......,...........,.........,........,..........,.....,,,.,,..................,.........,........,.........,,.........,,....,.............,.........,........,,.........,........,.,............,.,..,,.........,........,,.........,.........,,.......,..........,.........,.........,.........,.........,,,....,............,...,,....,........,,......,,.,.........,,..,....,.,........,"

    decoded = Ralgo(message).decode(depth=7, bits=9)

    assert str(decoded) == "Salut"

    # =======================

    message = ".......,,,,,,,,...................,.........,.........,........,,........,.,......,...........,.........,........,..........,.....,,,.,,..................,.........,........,.........,,.........,,....,.............,.........,........,,.........,........,.,............,.,..,,.........,........,,.........,.........,,.......,..........,.........,.........,.........,.........,,,....,............,...,,....,........,,......,,.,.........,,..,....,.,........,"

    decoded = Ralgo(message).decode()

    assert str(decoded) == ""

    # =======================

    message = fake.text()
    depth = 12
    bits = 42

    encoded = Ralgo(message).encode(depth=depth, bits=bits)
    decoded = encoded.decode(depth=depth, bits=bits)

    assert str(decoded) == message
